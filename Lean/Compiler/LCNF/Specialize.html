<html lang="en"><head><meta charset="UTF-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><link rel="stylesheet" href="../../.././style.css"></link><link rel="stylesheet" href="../../.././src/pygments.css"></link><link rel="shortcut icon" href="../../.././favicon.ico"></link><link rel="prefetch" href="../../.././/declarations/declaration-data.bmp" as="image"></link><title>Lean.Compiler.LCNF.Specialize</title><script defer="true" src="../../.././mathjax-config.js"></script><script defer="true" src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script defer="true" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>const SITE_ROOT="../../.././";</script><script>const MODULE_NAME="Lean.Compiler.LCNF.Specialize";</script><script type="module" src="../../.././nav.js"></script><script type="module" src="../../.././search.js"></script><script type="module" src="../../.././how-about.js"></script><script type="module" src="../../.././instances.js"></script><script type="module" src="../../.././importedBy.js"></script></head><body><input id="nav_toggle" type="checkbox"></input><header><h1><label for="nav_toggle"></label>Documentation</h1><p class="header_filename break_within">Lean.Compiler.LCNF.Specialize</p><form action="https://google.com/search" method="get" id="search_form"><input type="hidden" name="sitesearch" value="https://leanprover-community.github.io/mathlib_docs"></input><input type="text" name="q" autocomplete="off"></input><button>Google site search</button></form></header><nav class="internal_nav"><h3><a class="break_within" href="#top">Lean.Compiler.LCNF.Specialize</a></h3><p class="gh_nav_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean">source</a></p><div class="imports"><details><summary>Imports</summary><ul><li><a href="../../.././Init.html">Init</a></li><li><a href="../../.././Lean/Compiler/Specialize.html">Lean.Compiler.Specialize</a></li><li><a href="../../.././Lean/Util/ForEachExpr.html">Lean.Util.ForEachExpr</a></li><li><a href="../../.././Lean/Compiler/LCNF/Level.html">Lean.Compiler.LCNF.Level</a></li><li><a href="../../.././Lean/Compiler/LCNF/PhaseExt.html">Lean.Compiler.LCNF.PhaseExt</a></li><li><a href="../../.././Lean/Compiler/LCNF/PrettyPrinter.html">Lean.Compiler.LCNF.PrettyPrinter</a></li><li><a href="../../.././Lean/Compiler/LCNF/Simp.html">Lean.Compiler.LCNF.Simp</a></li><li><a href="../../.././Lean/Compiler/LCNF/SpecInfo.html">Lean.Compiler.LCNF.SpecInfo</a></li><li><a href="../../.././Lean/Compiler/LCNF/ToExpr.html">Lean.Compiler.LCNF.ToExpr</a></li></ul></details><details><summary>Imported by</summary><ul id="imported-by-Lean.Compiler.LCNF.Specialize" class="imported-by-list"></ul></details></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Cache">Lean.Compiler.LCNF.Specialize.Cache</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.specCacheExt">Lean.Compiler.LCNF.Specialize.specCacheExt</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.cacheSpec">Lean.Compiler.LCNF.Specialize.cacheSpec</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.findSpecCache?">Lean.Compiler.LCNF.Specialize.findSpecCache?</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Context">Lean.Compiler.LCNF.Specialize.Context</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.State">Lean.Compiler.LCNF.Specialize.State</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.withParams">Lean.Compiler.LCNF.Specialize.withParams</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.withFVar">Lean.Compiler.LCNF.Specialize.withFVar</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.isGround">Lean.Compiler.LCNF.Specialize.isGround</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.withLetDecl">Lean.Compiler.LCNF.Specialize.withLetDecl</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.State">Lean.Compiler.LCNF.Specialize.Collector.State</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.markVisited">Lean.Compiler.LCNF.Specialize.Collector.markVisited</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.collectParams">Lean.Compiler.LCNF.Specialize.Collector.collectParams</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.collectCode">Lean.Compiler.LCNF.Specialize.Collector.collectCode</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.collectFunDecl">Lean.Compiler.LCNF.Specialize.Collector.collectFunDecl</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.collectFVar">Lean.Compiler.LCNF.Specialize.Collector.collectFVar</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.collectExpr">Lean.Compiler.LCNF.Specialize.Collector.collectExpr</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.Collector.collect">Lean.Compiler.LCNF.Specialize.Collector.collect</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.shouldSpecialize">Lean.Compiler.LCNF.Specialize.shouldSpecialize</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.expandCodeDecls">Lean.Compiler.LCNF.Specialize.expandCodeDecls</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.expandCodeDecls.go">Lean.Compiler.LCNF.Specialize.expandCodeDecls.go</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.mkKey">Lean.Compiler.LCNF.Specialize.mkKey</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.mkSpecDecl">Lean.Compiler.LCNF.Specialize.mkSpecDecl</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.mkSpecDecl.go">Lean.Compiler.LCNF.Specialize.mkSpecDecl.go</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.getRemainingArgs">Lean.Compiler.LCNF.Specialize.getRemainingArgs</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.specializeApp?">Lean.Compiler.LCNF.Specialize.specializeApp?</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.visitFunDecl">Lean.Compiler.LCNF.Specialize.visitFunDecl</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.visitCode">Lean.Compiler.LCNF.Specialize.visitCode</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Specialize.main">Lean.Compiler.LCNF.Specialize.main</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Decl.specialize">Lean.Compiler.LCNF.Decl.specialize</a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.specialize">Lean.Compiler.LCNF.specialize</a></div></nav><main>
<div class="decl" id="Lean.Compiler.LCNF.Specialize.Cache"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L18-L18">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Cache">Lean.Compiler.LCNF.Specialize.Cache</a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn">Type</span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Cache">Lean.Compiler.LCNF.Specialize.Cache</a> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn"><a href="../../.././Lean/Data/PersistentHashMap.html#Lean.PHashMap">Lean.PHashMap</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.specCacheExt"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L20-L21">source</a></div><div class="decl_header"><span class="decl_kind">opaque</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.specCacheExt">Lean.Compiler.LCNF.Specialize.specCacheExt</a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Environment.html#Lean.EnvExtension">Lean.EnvExtension</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Cache">Lean.Compiler.LCNF.Specialize.Cache</a></span></div></div></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.cacheSpec"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L23-L24">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.cacheSpec">Lean.Compiler.LCNF.Specialize.cacheSpec</a></span><span class="decl_args">
<span class="fn">(key : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args">
<span class="fn">(declName : <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/CoreM.html#Lean.Core.CoreM">Lean.CoreM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.findSpecCache?"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L26-L27">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.findSpecCache?">Lean.Compiler.LCNF.Specialize.findSpecCache?</a></span><span class="decl_args">
<span class="fn">(key : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/CoreM.html#Lean.Core.CoreM">Lean.CoreM</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span>)</span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.findSpecCache?">Lean.Compiler.LCNF.Specialize.findSpecCache?</a> <span class="fn">key</span></span> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn">do
  let a ← <span class="fn">Lean.getEnv</span>
  <span class="fn"><a href="../../.././Init/Prelude.html#Pure.pure">pure</a> (<span class="fn"><a href="../../.././Lean/Data/PersistentHashMap.html#Lean.PersistentHashMap.find?">Lean.PersistentHashMap.find?</a> (<span class="fn"><a href="../../.././Lean/Environment.html#Lean.EnvExtension.getState">Lean.EnvExtension.getState</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.specCacheExt">Lean.Compiler.LCNF.Specialize.specCacheExt</a> <span class="fn">a</span></span>) <span class="fn">key</span></span>)</span></span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Context"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L29-L42">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Context">Lean.Compiler.LCNF.Specialize.Context</a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn">Type</span></div></div><ul class="structure_fields" id="Lean.Compiler.LCNF.Specialize.Context.mk"><li id="Lean.Compiler.LCNF.Specialize.Context.scope" class="structure_field"><div class="structure_field_doc"><p>Set of free variables in scope. The "collector" uses this information when collecting
dependencies for code specialization.</p></div><div class="structure_field_info">scope : <a href="../../.././Lean/Expr.html#Lean.FVarIdSet">Lean.FVarIdSet</a></div></li><li id="Lean.Compiler.LCNF.Specialize.Context.ground" class="structure_field"><div class="structure_field_doc"><p>Set of let-declarations in scope that do not depend on parameters.</p></div><div class="structure_field_info">ground : <a href="../../.././Lean/Expr.html#Lean.FVarIdSet">Lean.FVarIdSet</a></div></li><li id="Lean.Compiler.LCNF.Specialize.Context.declName" class="structure_field"><div class="structure_field_doc"><p>Name of the declaration being processed</p></div><div class="structure_field_info">declName : <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></div></li></ul><details class="instances"><summary>Instances For</summary><ul id="instances-for-list-Lean.Compiler.LCNF.Specialize.Context" class="instances-for-list"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.State"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L44-L45">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.State">Lean.Compiler.LCNF.Specialize.State</a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn">Type</span></div></div><ul class="structure_fields" id="Lean.Compiler.LCNF.Specialize.State.mk"><li id="Lean.Compiler.LCNF.Specialize.State.decls" class="structure_field"><div class="structure_field_info">decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span></div></li></ul><details class="instances"><summary>Instances For</summary><ul id="instances-for-list-Lean.Compiler.LCNF.Specialize.State" class="instances-for-list"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.SpecializeM"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L47-L47">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a></span><span class="decl_args">
<span class="fn">(α : <span class="fn">Type</span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn">Type</span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Init/Prelude.html#ReaderT">ReaderT</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Context">Lean.Compiler.LCNF.Specialize.Context</a>
    (<span class="fn"><a href="../../.././Init/Control/StateRef.html#StateRefT'">StateRefT'</a> <a href="../../.././Init/System/IO.html#IO.RealWorld">IO.RealWorld</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.State">Lean.Compiler.LCNF.Specialize.State</a> <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a></span>)</span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.withParams"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L49-L50">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.withParams">Lean.Compiler.LCNF.Specialize.withParams</a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{α : <span class="fn">Type</span>}</span></span>
</span><span class="decl_args">
<span class="fn">(ps : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(x : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <span class="fn">α</span></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.withFVar"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L52-L53">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.withFVar">Lean.Compiler.LCNF.Specialize.withFVar</a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{α : <span class="fn">Type</span>}</span></span>
</span><span class="decl_args">
<span class="fn">(fvarId : <a href="../../.././Lean/Expr.html#Lean.FVarId">Lean.FVarId</a>)</span></span>
<span class="decl_args">
<span class="fn">(x : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <span class="fn">α</span></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.withFVar">Lean.Compiler.LCNF.Specialize.withFVar</a> <span class="fn">fvarId</span> <span class="fn">x</span></span> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Init/Prelude.html#MonadWithReader.withReader">withReader</a>
    (<span class="fn">fun <span class="fn">ctx</span> =&gt <span class="fn">{ <span class="fn">scope</span> := <span class="fn"><a href="../../.././Lean/Data/RBTree.html#Lean.RBTree.insert">Lean.RBTree.insert</a> <span class="fn"><span class="fn">ctx</span>.scope</span> <span class="fn">fvarId</span></span>, <span class="fn">ground</span> := <span class="fn"><span class="fn">ctx</span>.ground</span>, <span class="fn">declName</span> := <span class="fn"><span class="fn">ctx</span>.declName</span> }</span></span>) <span class="fn">x</span></span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.isGround"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L59-L61">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.isGround">Lean.Compiler.LCNF.Specialize.isGround</a></span><span class="decl_args">
<span class="fn">(e : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Init/Prelude.html#Bool">Bool</a></span></div></div><p>Return <code>true</code> if <code>e</code> is a ground term. That is,
it contains only free variables t</p><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.isGround">Lean.Compiler.LCNF.Specialize.isGround</a> <span class="fn">e</span></span> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn">do
  let a ← <span class="fn">read</span>
  let s : <a href="../../.././Lean/Expr.html#Lean.FVarIdSet">Lean.FVarIdSet</a> := <span class="fn"><span class="fn">a</span>.ground</span>
  <span class="fn"><a href="../../.././Init/Prelude.html#Pure.pure">pure</a> <span class="fn"><a href="../../.././Init/Prelude.html#not">!</a><span class="fn"><a href="../../.././Lean/Expr.html#Lean.Expr.hasAnyFVar">Lean.Expr.hasAnyFVar</a> <span class="fn">e</span> <span class="fn">fun <span class="fn">a</span> =&gt <span class="fn"><a href="../../.././Init/Prelude.html#not">!</a><span class="fn"><a href="../../.././Lean/Data/RBTree.html#Lean.RBTree.contains">Lean.RBTree.contains</a> <span class="fn">s</span> <span class="fn">a</span></span></span></span></span></span></span></span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.withLetDecl"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L63-L66">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.withLetDecl">Lean.Compiler.LCNF.Specialize.withLetDecl</a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{α : <span class="fn">Type</span>}</span></span>
</span><span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.LetDecl">Lean.Compiler.LCNF.LetDecl</a>)</span></span>
<span class="decl_args">
<span class="fn">(x : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <span class="fn">α</span></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="mod_doc"><h1 class="markdown-heading" id="Dependency-collector-for-the-code-specialization-function">Dependency collector for the code specialization function. <a class="hover-link" href="#Dependency-collector-for-the-code-specialization-function">#</a></h1><p>During code specialization, we select which arguments are going to be used during the specialization.
Then, we have to collect their dependencies. For example, suppose are trying to specialize the following <code><a href="../../.././Init/System/IO.html#IO.println">IO.println</a></code>
and <code><a href="../../.././Init/Data/List/Control.html#List.forM">List.forM</a></code> applications in the following example:</p><pre><code>    def f xs a.1 :=
      let _x.2 := @instMonadEIO <a href="../../.././Init/System/IOError.html#IO.Error">IO.Error</a>
      let _x.5 := <a href="../../.././Init/Data/ToString/Basic.html#instToStringString">instToStringString</a>
      let _x.9 := <a href="../../.././Init/Data/ToString/Basic.html#instToStringNat">instToStringNat</a>
      let _x.6 := "hello"
      let _x.61 := @IO.println <a href="../../.././Init/Prelude.html#String">String</a> _x.5 _x.6 a.1 -- (*)
      cases _x.61
      | <a href="../../.././Init/Prelude.html#EStateM.Result.ok">EStateM.Result.ok</a> a.6 a.7 =>
        fun _f.72 _y.69 _y.70 :=
          let _x.71 := @IO.println <a href="../../.././Init/Prelude.html#Nat">Nat</a> _x.9 _y.69 _y.70 -- (*)
          _x.71
        let _x.65 := @List.forM (fun α => <a href="../../.././Init/Prelude.html#PUnit">PUnit</a> → <a href="../../.././Init/Prelude.html#EStateM.Result">EStateM.Result</a> <a href="../../.././Init/System/IOError.html#IO.Error">IO.Error</a> <a href="../../.././Init/Prelude.html#PUnit">PUnit</a> α) _x.2 <a href="../../.././Init/Prelude.html#Nat">Nat</a> xs _f.72 a.7 -- (*)
        ...
      ...
</code></pre><p>For <code><a href="../../.././Init/System/IO.html#IO.println">IO.println</a></code> the <code>SpecArgInfo</code> is <code>[N, I, O, O]</code>, i.e., only the first two arguments are considered
for code specialization. The first one is computationally neutral, and the second one is an instance.
For <code><a href="../../.././Init/Data/List/Control.html#List.forM">List.forM</a></code>, we have <code>[N, I, N, O, H]</code>. In this case, the fifth argument (tagged as <code>H</code>) is a function.
Note that the actual <code><a href="../../.././Init/Data/List/Control.html#List.forM">List.forM</a></code> application has 6 arguments, the extra argument comes from the <code><a href="../../.././Init/System/IO.html#IO">IO</a></code> monad.</p><p>For the first <code><a href="../../.././Init/System/IO.html#IO.println">IO.println</a></code> application, the collector collects <code>_x.5</code>.
For the <code><a href="../../.././Init/Data/List/Control.html#List.forM">List.forM</a></code>, it collects <code>_x.2</code>, <code>_x.9</code>, and <code>_f.72</code>.
The collected values are used to construct a key to identify the specialization. Arguments that were not considered are
replaced with <code><a href="../../.././Init/Prelude.html#lcErased">lcErased</a></code>. The key is used to make sure we don't keep generating the same specialization over and over again.
This is not an optimization, it is essential to prevent the code specializer from looping while specializing recursive functions.
The keys for these two applications are the terms.</p><pre><code>@IO.println <a href="../../.././Init/Prelude.html#Nat">Nat</a> <a href="../../.././Init/Data/ToString/Basic.html#instToStringNat">instToStringNat</a> <a href="../../.././Init/Prelude.html#lcErased">lcErased</a> <a href="../../.././Init/Prelude.html#lcErased">lcErased</a>
</code></pre><p>and</p><pre><code>@List.forM
  (fun α => <a href="../../.././Init/Prelude.html#PUnit">PUnit</a> → <a href="../../.././Init/Prelude.html#EStateM.Result">EStateM.Result</a> <a href="../../.././Init/System/IOError.html#IO.Error">IO.Error</a> <a href="../../.././Init/Prelude.html#PUnit">PUnit</a> α)
  (@instMonadEIO IO.Error) <a href="../../.././Init/Prelude.html#Nat">Nat</a> <a href="../../.././Init/Prelude.html#lcErased">lcErased</a>
  (fun _y.69 _y.70 =>
   let _x.71 := @IO.println <a href="../../.././Init/Prelude.html#Nat">Nat</a> <a href="../../.././Init/Data/ToString/Basic.html#instToStringNat">instToStringNat</a> _y.69 _y.70;
  _x.71)
</code></pre><p>The keys never contain free variables or loose bound variables.</p></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.State"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L120-L138">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.State">Lean.Compiler.LCNF.Specialize.Collector.State</a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn">Type</span></div></div><ul class="structure_fields" id="Lean.Compiler.LCNF.Specialize.Collector.State.mk"><li id="Lean.Compiler.LCNF.Specialize.Collector.State.visited" class="structure_field"><div class="structure_field_doc"><p>Set of already visited free variables.</p></div><div class="structure_field_info">visited : <a href="../../.././Lean/Expr.html#Lean.FVarIdSet">Lean.FVarIdSet</a></div></li><li id="Lean.Compiler.LCNF.Specialize.Collector.State.params" class="structure_field"><div class="structure_field_doc"><p>Free variables that must become new parameters of the code being specialized.</p></div><div class="structure_field_info">params : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span></div></li><li id="Lean.Compiler.LCNF.Specialize.Collector.State.decls" class="structure_field"><div class="structure_field_doc"><p>Let-declarations and local function declarations that are going to be "copied" to the code
being specialized. For example, the let-declarations often contain the instance values.
In the current specialization heuristic all let-declarations are ground values (i.e., they do not contain free-variables).
However, local function declarations may contain free variables.</p><p>The current heuristic tries to avoid work duplication. If a let-declaration is a ground value,
it most likely will be computed during compilation time, and work duplication is not an issue.</p></div><div class="structure_field_info">decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span></div></li></ul><p>State for the <code><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">CollectorM</a></code> monad.</p><details class="instances"><summary>Instances For</summary><ul id="instances-for-list-Lean.Compiler.LCNF.Specialize.Collector.State" class="instances-for-list"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.CollectorM"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L144-L144">source</a></div><div class="attributes">@[inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a></span><span class="decl_args">
<span class="fn">(α : <span class="fn">Type</span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn">Type</span></div></div><p>Monad for implementing the code specializer dependency collector.
See <code><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collect">collect</a></code></p><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Init/Control/StateRef.html#StateRefT'">StateRefT'</a> <a href="../../.././Init/System/IO.html#IO.RealWorld">IO.RealWorld</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.State">Lean.Compiler.LCNF.Specialize.Collector.State</a> <a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a></span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.markVisited"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L150-L151">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.markVisited">Lean.Compiler.LCNF.Specialize.Collector.markVisited</a></span><span class="decl_args">
<span class="fn">(fvarId : <a href="../../.././Lean/Expr.html#Lean.FVarId">Lean.FVarId</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><p>Mark a free variable as already visited.
We perform a topological sort over the dependencies.</p><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.markVisited">Lean.Compiler.LCNF.Specialize.Collector.markVisited</a> <span class="fn">fvarId</span></span> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Init/Prelude.html#modify">modify</a> <span class="fn">fun <span class="fn">s</span> =&gt <span class="fn">{ <span class="fn">visited</span> := <span class="fn"><a href="../../.././Lean/Data/RBTree.html#Lean.RBTree.insert">Lean.RBTree.insert</a> <span class="fn"><span class="fn">s</span>.visited</span> <span class="fn">fvarId</span></span>, <span class="fn">params</span> := <span class="fn"><span class="fn">s</span>.params</span>, <span class="fn">decls</span> := <span class="fn"><span class="fn">s</span>.decls</span> }</span></span></span></span></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.collectParams"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L158-L159">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collectParams">Lean.Compiler.LCNF.Specialize.Collector.collectParams</a></span><span class="decl_args">
<span class="fn">(params : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><p>Collect dependencies in parameters. We need this because parameters may
contain other type parameters.</p></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.collectCode"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L165-L178">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collectCode">Lean.Compiler.LCNF.Specialize.Collector.collectCode</a></span><span class="decl_args">
<span class="fn">(c : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Code">Lean.Compiler.LCNF.Code</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><p>Collect dependencies in the given code. We need this function to be able
to collect dependencies in a local function declaration.</p></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.collectFunDecl"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L181-L184">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collectFunDecl">Lean.Compiler.LCNF.Specialize.Collector.collectFunDecl</a></span><span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.FunDecl">Lean.Compiler.LCNF.FunDecl</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><p>Collect dependencies of a local function declaration.</p></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.collectFVar"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L190-L211">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collectFVar">Lean.Compiler.LCNF.Specialize.Collector.collectFVar</a></span><span class="decl_args">
<span class="fn">(fvarId : <a href="../../.././Lean/Expr.html#Lean.FVarId">Lean.FVarId</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><p>Process the given free variable.
If it has not already been visited and is in scope, we collect its dependencies.</p></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.collectExpr"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L214-L218">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collectExpr">Lean.Compiler.LCNF.Specialize.Collector.collectExpr</a></span><span class="decl_args">
<span class="fn">(e : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><p>Collect dependencies of the given expression.</p></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.Collector.collect"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L230-L239">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collect">Lean.Compiler.LCNF.Specialize.Collector.collect</a></span><span class="decl_args">
<span class="fn">(paramsInfo : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/SpecInfo.html#Lean.Compiler.LCNF.SpecParamInfo">Lean.Compiler.LCNF.SpecParamInfo</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(args : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.CollectorM">Lean.Compiler.LCNF.Specialize.Collector.CollectorM</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span>)</span></div></div><p>Given the specialization mask <code>paramsInfo</code> and the arguments <code>args</code>,
collect their dependencies, and return an array <code>mask</code> of size <code>paramsInfo.size</code> s.t.</p><ul>
<li><code>mask[i] = some args[i]</code> if <code>paramsInfo[i] != .other</code></li>
<li><code>mask[i] = none</code>, otherwise.
That is, <code>mask</code> contains only the arguments that are contributing to the code specialization.
We use this information to compute a "key" to uniquely identify the code specialization, and
creating the specialized code.</li>
</ul><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.shouldSpecialize"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L246-L253">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.shouldSpecialize">Lean.Compiler.LCNF.Specialize.shouldSpecialize</a></span><span class="decl_args">
<span class="fn">(paramsInfo : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/SpecInfo.html#Lean.Compiler.LCNF.SpecParamInfo">Lean.Compiler.LCNF.SpecParamInfo</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(args : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Init/Prelude.html#Bool">Bool</a></span></div></div><p>Return <code>true</code> if it is worth using arguments <code>args</code> for specialization given the parameter specialization information.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.expandCodeDecls"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L259-L272">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.expandCodeDecls">Lean.Compiler.LCNF.Specialize.expandCodeDecls</a></span><span class="decl_args">
<span class="fn">(decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(body : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span></div></div><p>Convert the given declarations into <code>Expr</code>, and "zeta-reduce" them into body.
This function is used to compute the key that uniquely identifies an code specialization.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.expandCodeDecls.go"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L264-L270">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.expandCodeDecls.go">Lean.Compiler.LCNF.Specialize.expandCodeDecls.go</a></span><span class="decl_args">
<span class="fn">(body : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args">
<span class="fn">(xs : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(values : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(i : <a href="../../.././Init/Prelude.html#Nat">Nat</a>)</span></span>
<span class="decl_args">
<span class="fn">(subst : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.mkKey"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L280-L285">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.mkKey">Lean.Compiler.LCNF.Specialize.mkKey</a></span><span class="decl_args">
<span class="fn">(params : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(body : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a> (<span class="fn"><a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a> <a href="../../.././Init/Prelude.html#Prod">×</a> <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span></span>)</span></div></div><p>Create the "key" that uniquely identifies a code specialization.
<code>params</code> and <code>decls</code> are the declarations collected by the <code><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.Collector.collect">collect</a></code> function above.
The result contains the list of universe level parameter names the key that <code>params</code>, <code>decls</code>, and <code>body</code> depends on.
We use this information to create the new auxiliary declaration and resulting application.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.mkSpecDecl"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L296-L332">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.mkSpecDecl">Lean.Compiler.LCNF.Specialize.mkSpecDecl</a></span><span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a>)</span></span>
<span class="decl_args">
<span class="fn">(us : <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Lean/Level.html#Lean.Level">Lean.Level</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(argMask : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span>)</span></span>
<span class="decl_args">
<span class="fn">(params : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(levelParamsNew : <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span></div></div><p>Specialize <code>decl</code> using</p><ul>
<li><code>us</code>: the universe level used to instantiate <code>decl.name</code></li>
<li><code>argMask</code>: arguments that are being used to specialize the declaration.</li>
<li><code>params</code>: new parameters that arguments in <code>argMask</code> depend on.</li>
<li><code>decls</code>: local declarations that arguments in <code>argMask</code> depend on.</li>
<li><code>levelParamsNew</code>: the universe level parameters for the new declaration.</li>
</ul><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.mkSpecDecl.go"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L310-L332">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.mkSpecDecl.go">Lean.Compiler.LCNF.Specialize.mkSpecDecl.go</a></span><span class="decl_args">
<span class="fn">(us : <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Lean/Level.html#Lean.Level">Lean.Level</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(argMask : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span>)</span></span>
<span class="decl_args">
<span class="fn">(params : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Lean.Compiler.LCNF.Param</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(decls : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.CodeDecl">Lean.Compiler.LCNF.CodeDecl</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(levelParamsNew : <span class="fn"><a href="../../.././Init/Prelude.html#List">List</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a>)</span></span>
<span class="decl_args">
<span class="fn">(nameNew : <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.Internalize.InternalizeM">Lean.Compiler.LCNF.Internalize.InternalizeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.getRemainingArgs"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L338-L343">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.getRemainingArgs">Lean.Compiler.LCNF.Specialize.getRemainingArgs</a></span><span class="decl_args">
<span class="fn">(paramsInfo : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/SpecInfo.html#Lean.Compiler.LCNF.SpecParamInfo">Lean.Compiler.LCNF.SpecParamInfo</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(args : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span></div></div><p>Given the specialization mask <code>paramsInfo</code> and the arguments <code>args</code>,
return the arguments that have not been considered for specialization.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.specializeApp?"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L350-L384">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.specializeApp?">Lean.Compiler.LCNF.Specialize.specializeApp?</a></span><span class="decl_args">
<span class="fn">(e : <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Expr.html#Lean.Expr">Lean.Expr</a></span>)</span></div></div><p>Try to specialize the function application in the given let-declaration.
<code>k</code> is the continuation for the let-declaration.</p></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.visitFunDecl"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L386-L388">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.visitFunDecl">Lean.Compiler.LCNF.Specialize.visitFunDecl</a></span><span class="decl_args">
<span class="fn">(funDecl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.FunDecl">Lean.Compiler.LCNF.FunDecl</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.FunDecl">Lean.Compiler.LCNF.FunDecl</a></span></div></div></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.visitCode"><div class="opaque"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L390-L408">source</a></div><div class="decl_header"><span class="decl_kind">partial def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.visitCode">Lean.Compiler.LCNF.Specialize.visitCode</a></span><span class="decl_args">
<span class="fn">(code : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Code">Lean.Compiler.LCNF.Code</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Code">Lean.Compiler.LCNF.Code</a></span></div></div></div></div><div class="decl" id="Lean.Compiler.LCNF.Specialize.main"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L412-L417">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.main">Lean.Compiler.LCNF.Specialize.main</a></span><span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Specialize.SpecializeM">Lean.Compiler.LCNF.Specialize.SpecializeM</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Decl.specialize"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L421-L423">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.Decl.specialize">Lean.Compiler.LCNF.Decl.specialize</a></span><span class="decl_args">
<span class="fn">(decl : <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a> (<span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Lean.Compiler.LCNF.Decl</a></span>)</span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.specialize"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/e44fd19074259018b9ddcbdb00209492416bc8ac/src/Lean/Compiler/LCNF/Specialize.lean#L425-L430">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/Specialize.html#Lean.Compiler.LCNF.specialize">Lean.Compiler.LCNF.specialize</a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Compiler/LCNF/PassManager.html#Lean.Compiler.LCNF.Pass">Lean.Compiler.LCNF.Pass</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details></div></div></main>
<nav class="nav"><iframe src="../../.././/navbar.html" class="navframe" frameBorder="0"></iframe></nav></body></html>